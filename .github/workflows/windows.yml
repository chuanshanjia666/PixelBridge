name: Windows Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-windows:
    name: Windows (${{ matrix.arch }}) Build
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            sys: ucrt64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-pkg-config
            mingw-w64-ucrt-x86_64-ffmpeg
            mingw-w64-ucrt-x86_64-spdlog
            mingw-w64-ucrt-x86_64-qt6-base
            mingw-w64-ucrt-x86_64-qt6-multimedia
            mingw-w64-ucrt-x86_64-qt6-declarative
            mingw-w64-ucrt-x86_64-qt6-shadertools
            mingw-w64-ucrt-x86_64-qt6-translations
            mingw-w64-ucrt-x86_64-qt6-tools
            mingw-w64-ucrt-x86_64-qt6-svg

      - name: Configure CMake
        run: |
          cmake -B build/release -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build/release --parallel

      - name: Debug PATH and Tool Locations
        run: |
          echo "MSYSTEM_PREFIX: $MSYSTEM_PREFIX"
          echo "Searching for windeployqt6..."
          find $MSYSTEM_PREFIX -name "windeployqt6.exe"
          echo "Searching for qmlimportscanner..."
          find $MSYSTEM_PREFIX -name "qmlimportscanner.exe"
          echo "PATH is: $PATH"

      - name: Package (ZIP)
        run: |
          # Ensure Qt helper tools are in PATH for windeployqt
          # Use cygpath to get the absolute Windows path for the bin directories
          QT_BIN_DIR=$(cygpath -u "$MSYSTEM_PREFIX/bin")
          QT_HELPER_DIR=$(cygpath -u "$MSYSTEM_PREFIX/lib/qt6/bin")

          # Add to PATH (MSYS2 bash style)
          export PATH="$QT_BIN_DIR:$QT_HELPER_DIR:$PATH"

          # Also set QMAKE environment variable
          export QMAKE="$QT_BIN_DIR/qmake6.exe"

          EXE_PATH="build/release/PixelBridge.exe"

          # Use absolute Windows paths for windeployqt
          # windeployqt6 is a native Windows app, so it's better to give it Windows paths
          WINDEPLOYQT_EXE=$(cygpath -w "$QT_BIN_DIR/windeployqt6.exe")
          QML_DIR=$(cygpath -w "qml")
          TARGET_EXE=$(cygpath -w "$EXE_PATH")

          echo "Using windeployqt from: $WINDEPLOYQT_EXE"
          echo "Scanning QML from: $QML_DIR"

          # Now package
          cd build/release
          cpack -G ZIP

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PixelBridge-windows-${{ matrix.arch }}
          path: |
            build/release/*.zip
            build/release/*.exe
