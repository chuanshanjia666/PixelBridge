name: Windows Build

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]

jobs:
  build-windows:
    name: Windows (${{ matrix.arch }}) Build
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            sys: ucrt64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-pkg-config
            mingw-w64-ucrt-x86_64-ffmpeg
            mingw-w64-ucrt-x86_64-spdlog
            mingw-w64-ucrt-x86_64-qt6-base
            mingw-w64-ucrt-x86_64-qt6-multimedia
            mingw-w64-ucrt-x86_64-qt6-declarative
            mingw-w64-ucrt-x86_64-qt6-shadertools
            mingw-w64-ucrt-x86_64-qt6-translations
            mingw-w64-ucrt-x86_64-qt6-tools
            mingw-w64-ucrt-x86_64-qt6-svg

      - name: Configure CMake (preset)
        run: |
          cmake --preset=ucrt64

      - name: Build (preset)
        run: |
          cmake --build --preset=ucrt64 --parallel

      - name: Debug PATH and Tool Locations
        run: |
          echo "MSYSTEM_PREFIX: $MSYSTEM_PREFIX"
          echo "Searching for windeployqt6..."
          find $MSYSTEM_PREFIX -name "windeployqt6.exe"
          echo "Searching for qmlimportscanner..."
          find $MSYSTEM_PREFIX -name "qmlimportscanner.exe"
          echo "PATH is: $PATH"

      - name: Bundle runtime and package
        id: bundle
        run: |
          set -e

          # Read version from VERSION file
          PIXELBRIDGE_VERSION=$(cat VERSION | tr -d '\n\r')
          echo "version=$PIXELBRIDGE_VERSION" >> $GITHUB_OUTPUT

          # Ensure Qt helper tools (including qmlimportscanner) are in PATH for windeployqt
          QT_BIN_DIR=$(cygpath -u "$MSYSTEM_PREFIX/bin")
          QT_HELPER_DIR=$(cygpath -u "$MSYSTEM_PREFIX/share/qt6/bin")
          export PATH="$QT_BIN_DIR:$QT_HELPER_DIR:$PATH"
          export QMAKE="$QT_BIN_DIR/qmake6.exe"

          # Install to a staging directory first
          STAGE_DIR="$PWD/build/package"
          cmake --install build/ucrt64 --prefix "$STAGE_DIR"

          EXE_PATH="$STAGE_DIR/bin/PixelBridge.exe"

          # windeployqt is a native Windows tool; feed it Windows paths
          WINDEPLOYQT_EXE=$(cygpath -w "$QT_BIN_DIR/windeployqt6.exe")
          QML_DIR_WIN=$(cygpath -w "$PWD/qml")
          TARGET_EXE_WIN=$(cygpath -w "$EXE_PATH")
          STAGE_BIN_WIN=$(cygpath -w "$STAGE_DIR/bin")

          echo "Using windeployqt from: $WINDEPLOYQT_EXE"
          echo "Staging to: $STAGE_BIN_WIN"

          "$WINDEPLOYQT_EXE" --verbose 1 --qmldir "$QML_DIR_WIN" --no-translations --no-opengl-sw "$TARGET_EXE_WIN"

          # Copy non-Qt runtime DLLs (FFmpeg/OpenSSL/spdlog) alongside the exe
          STAGE_BIN_POSIX="$STAGE_DIR/bin"
          for pattern in avcodec-*.dll avformat-*.dll avutil-*.dll avdevice-*.dll swscale-*.dll swresample-*.dll spdlog.dll libssl-*.dll libcrypto-*.dll; do
            find "$MSYSTEM_PREFIX/bin" -maxdepth 1 -name "$pattern" -exec cp -u {} "$STAGE_BIN_POSIX" \;
          done

          # Create a zip from the staged install
          cd "$STAGE_DIR"
          cmake -E tar cf ../PixelBridge-windows-${{ matrix.arch }}-v${PIXELBRIDGE_VERSION}.zip --format=zip .

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PixelBridge-windows-${{ matrix.arch }}-v${{ steps.bundle.outputs.version }}
          path: |
            build/PixelBridge-windows-${{ matrix.arch }}-v${{ steps.bundle.outputs.version }}.zip
            build/package/bin/PixelBridge.exe
