name: AppImage Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-appimage:
    name: AppImage (${{ matrix.arch }}) Build
    runs-on: ${{ matrix.os }}
    container:
      image: archlinux:latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: ubuntu-24.04-arm64
            arch: arm64

    steps:
      - name: Install base dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel cmake ninja pkgconf wget

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          pacman -S --noconfirm \
            ffmpeg \
            spdlog \
            qt6-base \
            qt6-wayland \
            qt6-multimedia \
            qt6-shadertools \
            qt6-declarative \
            qt6-quickcontrols2 \
            mesa \
            fuse2 \
            libxcb \
            wayland \
            libxkbcommon \
            pipewire \
            libportal

      - name: Configure CMake
        run: |
          cmake --preset release -DCMAKE_INSTALL_PREFIX=/usr

      - name: Build
        run: |
          cmake --build --preset release --parallel

      - name: Package (AppImage)
        run: |
          # Detect architecture
          RAW_ARCH=$(uname -m)
          if [ "$RAW_ARCH" == "aarch64" ] || [ "$RAW_ARCH" == "arm64" ]; then
            APPIMG_ARCH="aarch64"
          else
            APPIMG_ARCH="x86_64"
          fi

          # Arch Linux environment settings for AppImage tools
          export APPIMAGE_EXTRACT_AND_RUN=1

          # Download tools
          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${APPIMG_ARCH}.AppImage"
          wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-${APPIMG_ARCH}.AppImage"
          chmod +x linuxdeploy*.AppImage

          # Rename plugin for linuxdeploy to find it
          mv "linuxdeploy-plugin-qt-${APPIMG_ARCH}.AppImage" linuxdeploy-plugin-qt.AppImage

          # Run packaging script
          export QMAKE=$(which qmake || which qmake6)
          bash scripts/package_appimage.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PixelBridge-appimage-${{ matrix.arch }}
          path: |
            PixelBridge*.AppImage
